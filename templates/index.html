{% extends "layout.%s.html"|format(config.TEMPLATE) %}

{% block extra_javascript %}
{{ super() }}
<script>
$(function() {
  $("#auth_container").hide();
  $("#result_form").submit(function() {
    var result = $("#raw_textarea");
    var result_submit = $("#result_submit");
    // Disable form components
    result.attr("disabled", "disabled").addClass("disabled");
    result_submit.attr("disabled", "disabled").addClass("disabled");

    $.post("{{ url_for('submit') }}",
      {
        raw_paste: result.val(),
        qty: $('#fit_qty').val(),
        hide_buttons: $("#hide-buttons").is(':checked'),
        paste_autosubmit: $("#paste-autosubmit").is(':checked'),
        save: $("#paste-save").is(':checked'),
        result_id: $('#working_id').val(),
        trade_region: $('#trade_region').val(),
        auth_code: $('#auth_code').val(),
      },
      function(data) {
        result.val('');
        // Enable form components
        result.removeAttr("disabled").removeClass("disabled");
        result_submit.removeAttr("disabled").removeClass("disabled");
        // Populate results
        $('#result_container').html(data);
        $('#working_id').val($('#return_id').text());
      }).error(function() {
        // Enable form components
        result.removeAttr("disabled").removeClass("disabled");
        result_submit.removeAttr("disabled").removeClass("disabled");
        alert("Server responded with an error.");
      });
    return false;
  });

  $("#auth_form").submit(function() {
    var auth_input = $("#auth_input");
    var auth_submit = $("#auth_submit");
    // Disable form components
    auth_input.attr("disabled", "disabled").addClass("disabled");
    auth_submit.attr("disabled", "disabled").addClass("disabled");

    $.post("{{ url_for('auth') }}",
      {
        auth_input: auth_input.val(),
        result_id: $('#working_id').val(),
      },
      function(data) {
        auth_input.val('');
        // Enable form components
        auth_input.removeAttr("disabled").removeClass("disabled");
        auth_submit.removeAttr("disabled").removeClass("disabled");
        // Populate results
        if (data == 'True') {
            $("#auth_container").hide();
            $("#result_form").show();
            }
        else {
            alert ("Not authorized!"); }
      }).error(function() {
        // Enable form components
        auth_input.removeAttr("disabled").removeClass("disabled");
        auth_submit.removeAttr("disabled").removeClass("disabled");
        alert("Server responded with an error.");
      });
    return false;
  });

  $("#copy_form").submit(function() {
    var copy_submit = $("#copy_submit");
    // Disable form components
    copy_submit.attr("disabled", "disabled").addClass("disabled");

    $.post("{{ url_for('copy') }}",
      {
        result_id: $('#working_id').val(),
      },
      function(data) {
        $("#auth_container").hide();
        $("#result_form").show();

        // Populate results
        $('#result_container').html(data);
        $('#working_id').val($('#return_id').text());
      }).error(function() {
        // Enable form components
        copy_submit.removeAttr("disabled").removeClass("disabled");
        alert("Server responded with an error.");
      });
    return false;
  });

  $("#raw_textarea").bind('paste', function(e) {
    if($('#paste-autosubmit:checked').length > 0) {
      setTimeout(function() {
        $('#result_form').submit();
      }, 0);
    }
  });

  function toggle_buttons() {
    if ($("#hide-buttons").is(':checked'))
    {
      $('#buttons').hide();
    } else {
      $('#buttons').show();
    }
  }
  $("#hide-buttons").click(function(e) { toggle_buttons(); });

  $('.dropdown-menu input, .dropdown-menu label').click(function(e) {
      e.stopPropagation();
  });

  {% if from_igb %}
    $('#hide-buttons').prop('checked', true);
    $('#paste-autosubmit').prop('checked', true);
  {% endif %}
  toggle_buttons();

  $("#modify-result").click(function() {
    if($(this).is(":checked")) {
        $('#working_id').val($('#return_id').text()); }
    else {
        $('#working_id').val(''); }
  });

  if ($("#modify-result").is(":checked")) {
        $('#working_id').val($('#return_id').text()); }
});
</script>

{% endblock %}
{% block body %}

    <div class="container">

      <div class="row">
        <div class="col-lg-5">
          <!--%% Paste Form %%-->
          <form action="{{ url_for('submit') }}" method="post" class="well well-small form-inline" id="result_form">
            <input type="hidden" id="working_id" name="working_id" value="{% if results and results.result_id %}{{ results.result_id }}{% endif %}" />
            <textarea class="form-control" id="raw_textarea" name="raw_textarea" rows="10" placeholder="Copy fit here">[Imperial Navy Slicer, t1 guns?]

Damage Control II
Inertia Stabilizers II
Nanofiber Internal Structure II
Overdrive Injector System II
Tracking Enhancer II

Limited 1MN Microwarpdrive I
Warp Disruptor II

Small Energy Neutralizer II
Small Focused Modulated Pulse Energy Beam I, Imperial Navy Microwave S
Small Focused Modulated Pulse Energy Beam I, Imperial Navy Microwave S

Small Capacitor Control Circuit I
Small Capacitor Control Circuit I
Small Processor Overclocking Unit I
</textarea>
            <div class="controls clearfix">
              <div class="pull-right">
              <input type="text" class="input-sm form-control" size='4' id="fit_qty" name="fit_qty" placeholder="QTY" />
              <select class="input-sm" id="trade_region">
                  <option value="">Market Regions</option>
                  {% for id, name in regions.iteritems(): %}
                  <option value="{{ id }}"{% if session.region_id == id: %} selected="selected"{% endif %}>{{ name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div id="buttons">
                <button type="submit" id="result_submit" class="btn btn-primary btn-sm">Submit</button>
                <button type="reset" class="btn btn-sm">Reset</button>

              </div>
              </div>
          </form>

          <!--%% Auth Form %%-->
          <div class="well well-small text-center" id="auth_container">
          <h3>Authorization</h3>
            <p>Enter the authorization code below to enable result modification</p>
            <form action="{{ url_for('auth') }}" method="post" class="form form-horizontal" id="auth_form">
              <div class="form-group">
                <div class="col-md-5 col-centered">
                  <input name="auth_input" id="auth_input" class="form-control input-lg" value="" maxlength="8" />
                </div>
              </div>
              <div class="controls form-inline clearfix">
                <button type="submit" id="auth_submit" class="btn btn-primary">Submit</button>
                <button type="submit" id="copy_submit" class="btn" name="copy_submit">Copy Result</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-lg-7" id="result_container">
          {% block results %}
            {% if error %}
            <div class="alert alert-error">
                <strong>ERROR:</strong> {{ error }}
            </div>
            {% endif %}
            <h4>What do I do?</h4>
            <p>
               Copy and Paste your EFT-formatted fitting into the field on the left, and press Submit to generate a result! Afterwards, you can continue to add to your previous result. Provided is an authentication code that can be used to restrict write-access to the results, and in the future there will be an option to restrict read-access via password.
            </p>
          {% endblock %}
        </div>
      </div>
    </div>
{% endblock %}